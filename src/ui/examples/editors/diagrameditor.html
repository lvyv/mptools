<html>
<head>
	<title>图片标注配置</title>
 	<link rel="stylesheet" href="css/wordpress.css" type="text/css" media="screen" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css" media="screen">
		#page { background: url("images/draw/drawbg.jpg") repeat-y top; border: none; }
	</style>
	<script type="text/javascript">
		var mxBasePath = '../../src';
		
		var urlParams = (function(url)
		{
			var result = new Object();
			var params = window.location.search.slice(1).split('&');
			
			for (var i = 0; i < params.length; i++)
			{
				idx = params[i].indexOf('=');
				
				if (idx > 0)
				{
					result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
				}
			}
			
			return result;
		})(window.location.href);
		
		var mxLanguage = urlParams['lang'];
	</script>
	<script type="text/javascript" src="../../src/js/mxClient.js"></script>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript">
		// Program starts here. The document.onLoad executes the
		// createEditor function with a given configuration.
		// In the config file, the mxEditor.onInit method is
		// overridden to invoke this global function as the
		// last step in the editor constructor.
		function onInit(editor)
		{
			// Enables rotation handle
			mxVertexHandler.prototype.rotationEnabled = true;

			// Enables guides
			mxGraphHandler.prototype.guidesEnabled = true;
			
		    // Alt disables guides
		    mxGuide.prototype.isEnabledForEvent = function(evt)
		    {
		    	return !mxEvent.isAltDown(evt);
		    };
			
			// Enables snapping waypoints to terminals
			mxEdgeHandler.prototype.snapToTerminals = true;
			
			// Defines an icon for creating new connections in the connection handler.
			// This will automatically disable the highlighting of the source vertex.
			mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);
			
			// Enables connections in the graph and disables
			// reset of zoom and translate on root change
			// (ie. switch between XML and graphical mode).
			editor.graph.setConnectable(false);

			// Clones the source if new connection has no target
			editor.graph.connectionHandler.setCreateTarget(true);

			// Updates the title if the root changes
			var title = document.getElementById('title');
			
			if (title != null)
			{
				var f = function(sender)
				{
					title.innerHTML = '航天云网 - ' + sender.getTitle();
				};
				
				editor.addListener(mxEvent.ROOT, f);
				f(editor);
			}
			
			/***** 定义预置点操作 *****/
			var container = document.querySelector("#viewports");
			var matches = container.querySelectorAll(".preview_img");
			var iii;
			for (iii = 0; iii < matches.length; iii++) {
				mxEvent.addListener(matches[iii], 'click', function(evt)
				{
					nd = evt.currentTarget;
					editor.execute('loadImage', nd);
				});
			}
			// 定义预置点的预览图片被点击的事件处理函数
			var funct = function(editor, nd)
			{
				var onload = function(req)
				{
					sc = req.getStatus()
					if(sc == 200) {
						base64 = 'data:image/png;base64, ' + req.getText();
						// img_url = '/viewport/needle.png'
						nd.setAttribute('src', base64)	//缩略图
						editor.graph.setBackgroundImage(new mxImage(base64, nd.naturalWidth, nd.naturalHeight));
						editor.graph.view.validate();	//必须调用以刷新视图背景
					}
				}

				var onerror = function(req)
				{
					mxUtils.alert('Error');
				}

				url = `/viewport/${nd.id}`
				
				mxUtils.get(url, onload, onerror, true);
			};
			editor.addAction('loadImage', funct);


			// Defines a new action to switch between
			// XML and graphical display
			var textNode = document.getElementById('xml');
			var graphNode = editor.graph.container;
			var sourceInput = document.getElementById('source');
			sourceInput.checked = false;

			var funct = function(editor)
			{
				if (sourceInput.checked)
				{
					graphNode.style.display = 'none';
					textNode.style.display = 'inline';
					
					var enc = new mxCodec();
					var node = enc.encode(editor.graph.getModel());
					
					textNode.value = mxUtils.getPrettyXml(node);
					textNode.originalValue = textNode.value;
					textNode.focus();
				}
				else
				{
					graphNode.style.display = '';
					
					if (textNode.value != textNode.originalValue)
					{
						var doc = mxUtils.parseXml(textNode.value);
						var dec = new mxCodec(doc);
						dec.decode(doc.documentElement, editor.graph.getModel());
					}

					textNode.originalValue = null;
					
					// Makes sure nothing is selected in IE
					if (mxClient.IS_IE)
					{
						mxUtils.clearSelection();
					}

					textNode.style.display = 'none';

					// Moves the focus back to the graph
					editor.graph.container.focus();
				}
			};
			
			editor.addAction('switchView', funct);
			
			// Defines a new action to switch between
			// XML and graphical display
			mxEvent.addListener(sourceInput, 'click', function()
			{
				editor.execute('switchView');
			});

			// Create select actions in page
			var node = document.getElementById('mainActions');
			var buttons = ['group', 'ungroup']; // , 'cut', 'copy', 'paste', 'delete', 'undo', 'redo', 'print', 'show'
			
			// Only adds image and SVG export if backend is available
			// NOTE: The old image export in mxEditor is not used, the urlImage is used for the new export.
			if (editor.urlImage != null)
			{
				// Client-side code for image export组合
				var exportImage = function(editor)
				{
					var graph = editor.graph;
					var scale = graph.view.scale;
					var bounds = graph.getGraphBounds();
					
		        	// New image export
					var xmlDoc = mxUtils.createXmlDocument();
					var root = xmlDoc.createElement('output');
					xmlDoc.appendChild(root);
					
				    // Renders graph. Offset will be multiplied with state's scale when painting state.
					var xmlCanvas = new mxXmlCanvas2D(root);
					xmlCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
					xmlCanvas.scale(scale);
					
					var imgExport = new mxImageExport();
				    imgExport.drawState(graph.getView().getState(graph.model.root), xmlCanvas);
				    
					// Puts request data together
					var w = Math.ceil(bounds.width * scale + 2);
					var h = Math.ceil(bounds.height * scale + 2);
					var xml = mxUtils.getXml(root);
					
					// Requests image if request is valid
					if (w > 0 && h > 0)
					{
						var name = 'export.png';
						var format = 'png';
						var bg = '&bg=#FFFFFF';
						
						new mxXmlRequest(editor.urlImage, 'filename=' + name + '&format=' + format +
		        			bg + '&w=' + w + '&h=' + h + '&xml=' + encodeURIComponent(xml)).
		        			simulate(document, '_blank');
					}
				};
				
				editor.addAction('exportImage', exportImage);
				
				// Client-side code for SVG export
				var exportSvg = function(editor)
				{
					var graph = editor.graph;
					var scale = graph.view.scale;
					var bounds = graph.getGraphBounds();

				    // Prepares SVG document that holds the output
				    var svgDoc = mxUtils.createXmlDocument();
				    var root = (svgDoc.createElementNS != null) ?
				    	svgDoc.createElementNS(mxConstants.NS_SVG, 'svg') : svgDoc.createElement('svg');
				    
					if (root.style != null)
					{
						root.style.backgroundColor = '#FFFFFF';
					}
					else
					{
						root.setAttribute('style', 'background-color:#FFFFFF');
					}
				    
				    if (svgDoc.createElementNS == null)
				    {
				    	root.setAttribute('xmlns', mxConstants.NS_SVG);
				    }
				    
				    root.setAttribute('width', Math.ceil(bounds.width * scale + 2) + 'px');
				    root.setAttribute('height', Math.ceil(bounds.height * scale + 2) + 'px');
				    root.setAttribute('xmlns:xlink', mxConstants.NS_XLINK);
				    root.setAttribute('version', '1.1');
				    
				    // Adds group for anti-aliasing via transform
				    var group = (svgDoc.createElementNS != null) ?
					    	svgDoc.createElementNS(mxConstants.NS_SVG, 'g') : svgDoc.createElement('g');
					group.setAttribute('transform', 'translate(0.5,0.5)');
					root.appendChild(group);
				    svgDoc.appendChild(root);

				    // Renders graph. Offset will be multiplied with state's scale when painting state.
				    var svgCanvas = new mxSvgCanvas2D(group);
				    svgCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
				    svgCanvas.scale(scale);
				    
				    var imgExport = new mxImageExport();
				    imgExport.drawState(graph.getView().getState(graph.model.root), svgCanvas);

					var name = 'export.svg';
				    var xml = encodeURIComponent(mxUtils.getXml(root));
					
					new mxXmlRequest(editor.urlEcho, 'filename=' + name + '&format=svg' + '&xml=' + xml).simulate(document, "_blank");
				};
				
				editor.addAction('exportSvg', exportSvg);
				
				buttons.push('exportImage');
				buttons.push('exportSvg');
			};
			
			for (var i = 0; i < buttons.length; i++)
			{
				var button = document.createElement('button');
				mxUtils.write(button, mxResources.get(buttons[i]));
			
				var factory = function(name)
				{
					return function()
					{
						editor.execute(name);
					};
				};
			
				mxEvent.addListener(button, 'click', factory(buttons[i]));
				node.appendChild(button);
			}

			// Create select actions in page
			var node = document.getElementById('selectActions');
			mxUtils.write(node, '选择: ');
			mxUtils.linkAction(node, '全选', editor, 'selectAll');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '不选', editor, 'selectNone');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '所有标注', editor, 'selectVertices');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '连线', editor, 'selectEdges');

			// Create select actions in page
			// var node = document.getElementById('zoomActions');
			mxUtils.write(node, ' 缩放: ');
			mxUtils.linkAction(node, '放大', editor, 'zoomIn');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '缩小', editor, 'zoomOut');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '原始大小', editor, 'actualSize');
			mxUtils.write(node, ', ');
			mxUtils.linkAction(node, '适应窗口', editor, 'fit');
			
			// editor.graph.setBackgroundImage(new mxImage('/viewport/instruments.png', 1000, 750));	//必须取到图片的原始尺寸确保从左上角0，0平铺
			// var parent = editor.graph.getDefaultParent();
			// editor.graph.insertVertex(parent, null, 'First Line\nSecond Line', 20, 10, 80, 100, 'defaultVertex');
			// var cell = editor.templates['rectangle'];
			// cell = editor.graph.cloneCell(cell);
			// editor.addVertex(null, cell, 300, 220);

		}

		window.onbeforeunload = function() { return mxResources.get('changesLost'); };
	</script>
	<!-- <script>
		function FlushImg(){
			nd = document.getElementById('flush_img1');
			nd.setAttribute('src', '/viewport/instruments.png')
			// $('#flush_img1').attr('src', '/viewport/instruments.png')
			// var xml = mxUtils.getXml(EditorUi.editor.getGraphXml());
			// console.log('xml', xml);
			// editor.graph.setBackgroundImage(new mxImage('/viewport/instruments.png', 1000, 750));	//必须取到图片的原始尺寸确保从左上角0，0平铺
			// $.ajax({
		 
			// 	url:"/flush_img",
			// 	type:'GET',
			// 	success: function (data) {
		 
			// 		$('#flush_img').attr('src', data)
			// 	},
			// })
		}
	</script> -->
</head>
<body onload="createEditor('config/diagrameditor.xml');">
	<div id="page">

		
		<div id="mainActions" style="width:100%;padding-top:8px;padding-left:24px;padding-bottom:8px;">
			<span id="selectActions" style="padding-left:24px;padding-bottom:4px;">
			</span>	
			<!-- <span id="zoomActions" style="width:50%;padding-right:54px;padding-top:4px;"></span> -->
			<span style="float:right;padding-right:80px;">
				<input id="source" type="checkbox"/>源数据
			</span>
		</div>

		
		<table border="0" width="730px">
			<tr>
				<td id="toolbar" style="width:16px;padding-left:20px;" valign="top">
					<!-- Toolbar Here -->				
				</td>
				<td valign="top" style="border-width:1px;border-style:solid;border-color:black;">
					<div id="graph" tabindex="-1" style="position:relative;height:480px;width:684px;overflow:hidden;cursor:default;">
						<!-- Graph Here -->
						<center id="splash" style="padding-top:230px;">
							<img src="images/loading.gif">
						</center>
					</div>
					<textarea id="xml" style="height:480px;width:684px;display:none;border-style:none;"></textarea>
				</td>
			</tr>
		</table>
		
		<div id="header">
			<div id="viewports" style="overflow:hidden;">
				<!-- <h1 id="title">Casicloud</h1> -->
				<!-- <img id= "flush_img1" src="/viewport/add-viewport.png" onclick="FlushImg()" ></img> -->
				<img id= "preset1" src="/viewport/add-viewport.png" class="preview_img" style="position:relative;height:46px;width:66px;overflow:hidden;cursor:default;padding-left:40px;padding-top:20px;"></img>
				<img id= "preset2" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset3" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset4" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset5" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset6" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset7" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset8" src="/viewport/add-viewport.png" class="preview_img"></img>
				<img id= "preset9" src="/viewport/add-viewport.png" class="preview_img"></img>
			</div>
		</div>
		
		<div id="footer">
			<p id="status">
				<!-- Status Here -->Loading...
			</p>
			<br/>
		</div>
	</div>
</body>
</html>
