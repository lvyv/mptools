<!DOCTYPE html>
<html>

<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <!-- Meta, title, CSS, favicons, etc. -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>视频智能分析软件 | 配置标注</title>

   <!-- Bootstrap -->
   <link href="vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome -->
   <link href="vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
   <!-- Custom styling plus plugins -->
   <link href="css/custom.css" rel="stylesheet">

   <!-- jQuery -->
   <script src="js/jquery.js"></script>
   <!-- Bootstrap -->
   <script src="js/bootstrap.js"></script>
   <script type="text/javascript">
      var mxBasePath = '../../src';

      var urlParams = (function (url) {
         var result = new Object();
         var params = window.location.search.slice(1).split('&');

         for (var i = 0; i < params.length; i++) {
            idx = params[i].indexOf('=');

            if (idx > 0) {
               result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
            }
         }

         return result;
      })(window.location.href);

      var mxLanguage = urlParams['lang'];
   </script>
   <script type="text/javascript" src="../../src/js/mxClient.js"></script>
   <script type="text/javascript" src="js/app.js"></script>
   <script type="text/javascript" src="js/xml2json.js"></script>
   <script type="text/javascript">
      let local_v2v_configuration_ = null
      let v2v_app_ = { "deviceid": null, "channelid": null, "editor": {} };	// 外部程序需要通过init_preview函数调用初始化本页面的这个结构
      // 本函数初始化全局配置变量
      function load_local_v2v_configuration(editor) {
         // console.log('loading configuration ...');
         // window.localStorage.clear();
         strconfig = window.localStorage.getItem('local_v2v_configuration_');
         if (strconfig) {
            local_v2v_configuration_ = JSON.parse(strconfig)
            local_v2v_configuration_.current_preset = null  // 初始化为正确状态很重要
         } else {
            // 如果本地没有完成过配置，则初始化配置信息
            local_v2v_configuration_ = { current_preset: null, presets: {} }
            // 读取html节点，看有多少个预置点
            let container = document.querySelector("#viewports");
            let matches = container.querySelectorAll(".preview_img");
            for (let iii = 0; iii < matches.length; iii++) {
               // console.log(matches[iii].id);
               local_v2v_configuration_.presets[matches[iii].id] = {mxGraphModel: null};  // selected表示是否当前被选中
            }
         }

      }
      function sleep(ms) {
         return new Promise(resolve => setTimeout(resolve, ms));
      }
      //把当前editor的模型转化为json对象
      function get_json_model(editor) {
         let codec = new mxCodec();
         let xnode = codec.encode(editor.graph.getModel());
         let x2js = new X2JS();
         let jso = x2js.xml2json(xnode);
         return jso;
      }
      //初始化空模型
      function create_empty_model(editor) {
         let mdstr = '<mxGraphModel><root>\
                           <Diagram label="照片标注" href="https://github.com/lvyv/mptools" id="0"><mxCell /></Diagram>\
                           <Layer label="Default Layer" id="1"><mxCell parent="0" /></Layer>\
                     </root></mxGraphModel>'
         let doc = mxUtils.parseXml(mdstr);
         let dec = new mxCodec(doc);
         dec.decode(doc.documentElement, editor.graph.getModel());
      }
      //设置当前的editor的模型
      function set_json_model(editor, jso) {
         if(jso.mxGraphModel) {
            let x2js = new X2JS();
            let xmlo = x2js.json2xml(jso);
            let codec = new mxCodec(xmlo);
            codec.decode(xmlo.documentElement, editor.graph.getModel());
         } else {    // 如果没有设置过jso
            create_empty_model(editor);
         }
      }
      // 本函数实现页面初始化的时候，更新预置点的thumbnail栏。
      function init_preview(devid, channelid, refresh) {
         let onload = function (req) {
            let sc = req.getStatus()
            if (sc == 200) {
               let container = document.querySelector("#viewports");
               // var matches = container.querySelectorAll(".preview_img");
               let ps = JSON.parse(req.getText());
               let iii;
               for (idx in ps.presets) {
                  url = ps.presets[idx];
                  items = url.split('/');
                  presetid = items[items.length - 1];
                  nd = document.querySelector(`#${presetid}`);
                  if (nd) {
                     req = mxUtils.load(url);
                     base64 = 'data:image/png;base64, ' + req.getText();
                     nd.setAttribute('src', base64);
                     nd.setAttribute('ori_width', ps.width);
                     nd.setAttribute('ori_height', ps.height);
                  }
               }
            }
         }
         let onerror = function (req) {
            mxUtils.alert('Error');
         }
         let url = `/api/v1/v2v/presets/${devid}/${channelid}?refresh=${refresh}`;
         mxUtils.get(url, onload, onerror);
      };

      // Program starts here. The document.onLoad executes the
      // createEditor function with a given configuration.
      // In the config file, the mxEditor.onInit method is
      // overridden to invoke this global function as the
      // last step in the editor constructor.
      function onInit(editor) {
         // Enables rotation handle
         mxVertexHandler.prototype.rotationEnabled = true;

         // Enables guides
         mxGraphHandler.prototype.guidesEnabled = true;

         // Alt disables guides
         mxGuide.prototype.isEnabledForEvent = function (evt) {
            return !mxEvent.isAltDown(evt);
         };

         // Enables snapping waypoints to terminals
         mxEdgeHandler.prototype.snapToTerminals = true;

         // Defines an icon for creating new connections in the connection handler.
         // This will automatically disable the highlighting of the source vertex.
         mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);

         // Enables connections in the graph and disables
         // reset of zoom and translate on root change
         // (ie. switch between XML and graphical mode).
         editor.graph.setConnectable(false);

         // Clones the source if new connection has no target
         editor.graph.connectionHandler.setCreateTarget(true);



         /***** 定义预置点操作 *****/
         let container = document.querySelector("#viewports");
         let matches = container.querySelectorAll(".preview_img");
         for (let iii = 0; iii < matches.length; iii++) {
            mxEvent.addListener(matches[iii], 'click', function (evt) {
               nd = evt.currentTarget;
               editor.execute('loadImage', nd);
            });
         }
         // 定义预置点的预览图片被点击的事件处理函数
         let funct = function (editor, nd) {
            // 一旦选中某个预置点，正确处理逻辑是保存现有的
            let curid = local_v2v_configuration_.current_preset;
            if (!curid) {
               curid = nd.id; // 启动以来从来没有点击选择过
               let md = local_v2v_configuration_.presets[nd.id];
               set_json_model(editor, md)
            }
            let jso = get_json_model(editor);
            local_v2v_configuration_.presets[curid].mxGraphModel = jso;

            local_v2v_configuration_.current_preset = nd.id;
            let md = local_v2v_configuration_.presets[nd.id];
            set_json_model(editor, md);

            let onload = function (req) {
               sc = req.getStatus()
               if (sc == 200) {
                  base64 = 'data:image/png;base64, ' + req.getText();
                  nd.setAttribute('src', base64)		//缩略图
                  sleep(100).then(() => {				   //等待渲染获得图片真实大小
                     editor.graph.setBackgroundImage(new mxImage(base64, nd.naturalWidth, nd.naturalHeight));
                     editor.graph.view.validate();	//必须调用以刷新视图背景
                  });
               } else {
                  nd.setAttribute('src', '/viewport/add-viewport.png');
                  editor.graph.setBackgroundImage(new mxImage('/viewport/add-viewport.png', 680, 480));
                  editor.graph.view.validate();	//必须调用以刷新视图背景
               }
            }
            let onerror = function (req) {
               mxUtils.alert('Error');
            }
            try {
               let url = `/viewport/${v2v_app_.deviceid}/${nd.id}.png`
               editor.graph.setBackgroundImage(new mxImage(url, nd.getAttribute('ori_width'), nd.getAttribute('ori_height')));
               editor.graph.view.validate();	//必须调用以刷新视图背景
            } catch (error) {
               editor.graph.setBackgroundImage(new mxImage('/viewport/add-viewport.png', 680, 480));
               editor.graph.view.validate();	//必须调用以刷新视图背景
            }
            // mxUtils.get(url, onload, onerror);
         };
         editor.addAction('loadImage', funct);

         // Defines a new action to switch between
         // XML and graphical display
         let textNode = document.getElementById('xml');
         let graphNode = editor.graph.container;
         let sourceInput = document.getElementById('source');
         sourceInput.checked = false;

         let funct_switch = function (editor) {
            if (sourceInput.checked) {
               graphNode.style.display = 'none';
               textNode.style.display = 'inline';

               let enc = new mxCodec();
               let node = enc.encode(editor.graph.getModel());

               textNode.value = mxUtils.getPrettyXml(node);
               textNode.originalValue = textNode.value;
               textNode.focus();
            }
            else {
               graphNode.style.display = '';

               if (textNode.value != textNode.originalValue) {
                  let doc = mxUtils.parseXml(textNode.value);
                  let dec = new mxCodec(doc);
                  dec.decode(doc.documentElement, editor.graph.getModel());
               }

               textNode.originalValue = null;

               // Makes sure nothing is selected in IE
               if (mxClient.IS_IE) {
                  mxUtils.clearSelection();
               }

               textNode.style.display = 'none';

               // Moves the focus back to the graph
               editor.graph.container.focus();
            }
         };

         editor.addAction('switchView', funct_switch);

         // Defines a new action to switch between
         // XML and graphical display
         mxEvent.addListener(sourceInput, 'click', function () {
            editor.execute('switchView');
         });


         $('#group_labels').click(function () {
            editor.execute('group');
         });
         $('#ungroup_labels').click(function () {
            editor.execute('ungroup');
         });
         $('#select_all').click(function () {
            editor.execute('selectAll');
         });
         $('#deselect_all').click(function () {
            editor.execute('selectNone');
         });
         $('#zoom_in').click(function () {
            editor.execute('zoomIn');
         });
         $('#zoom_out').click(function () {
            editor.execute('zoomOut');
         });
         $('#original_size').click(function () {
            editor.execute('actualSize');
         });
         $('#fit_window').click(function () {
            editor.execute('fit');
         });

         /* 自定义初始化操作 */
         load_local_v2v_configuration(editor)
         let viewports = document.getElementById('viewports')
         if (viewports) {
            // viewports.style.cursor = 'wait'
            v2v_app_.deviceid = viewports.getAttribute('deviceid');
            v2v_app_.channelid = viewports.getAttribute('channelid');
            init_preview(v2v_app_.deviceid, v2v_app_.channelid, true);
            // cur = editor.graph.getCursor()
         }
      }

      window.onbeforeunload = function () {
         // window.localStorage.clear();
         let curid = local_v2v_configuration_.current_preset;
         if (curid) {
            let jso = get_json_model(v2v_app_.editor);
            local_v2v_configuration_.presets[curid].mxGraphModel = jso;
         }
         let jso_cfg = JSON.stringify(local_v2v_configuration_);
         window.localStorage.setItem('local_v2v_configuration_', jso_cfg);
         console.log(jso_cfg);
         // let msg = mxResources.get('changesLost');
         return msg;
      };
   </script>

</head>

<body onload="v2v_app_.editor = createEditor('config/diagrameditor.xml');">
   <div class="container">
      <div class="main_container">
         <!-- page content -->
         <div id="page">

            <div class="x_panel" style="width:720px">
               <div class="x_title">
                  <ul class="nav panel_toolbox">



                     <li><a id="group_labels"><i class="fa fa-object-group"></i></a></li>
                     <li><a id="ungroup_labels"><i class="fa fa-object-ungroup"></i></a></li>

                     <li><a id="select_all"><i class="fa fa-check-circle"></i></a></li>
                     <li><a id="deselect_all"><i class="fa fa-ban"></i></a></li>
                     <li><a id="zoom_in"><i class="fa fa-search-plus"></i></a></li>
                     <li><a id="zoom_out"><i class="fa fa-search-minus"></i></a></li>
                     <li><a id="original_size"><i class="fa fa-codepen"></i></a></li>
                     <li><a id="fit_window"><i class="fa fa-arrows-alt"></i></a></li>

                     </li>

                  </ul>
                  <div class="clearfix"></div>
               </div>
               <div class="x_content" id="viewports" deviceid='34020000001320000001' , channelid='34020000001310000001'>
                  <div class="row">
                     <table>
                        <tr>
                           <td valign="top" style="border: thin solid #cecece; box-shadow:25px 0px 2px #cdcdcd;">
                              <div id="graph" tabindex="-1"
                                 style="position:relative;height:480px;width:680px;overflow:hidden;cursor:default;">
                                 <!-- Graph Here -->
                                 <center id="splash">
                                    <img src="images/loading.gif">
                                 </center>
                              </div>
                              <textarea id="xml"
                                 style="height:480px;width:680px;display:none;border-style:none;"></textarea>
                           </td>
                           <td id="toolbar" style="width:16px;padding-left:2px;" valign="top">
                              <!-- Toolbar Here -->
                           </td>
                        </tr>
                        <tr>
                           <td colspan="2">
                              <table class="tb_margin">
                                 <tr>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset1" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset2" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset3" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>

                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset4" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset5" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset6" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>

                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset7" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset8" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset9" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                 </tr>
                              </table>
                           </td>

                        </tr>
                     </table>
                  </div>

                  <div class="row">
                     <div>
                        <input id="source" style="margin-top: 10px" type="checkbox" /> 源数据
                     </div>
                  </div>
               </div>
            </div>


         </div>
         <!-- /page content -->
      </div>

</body>

</html>