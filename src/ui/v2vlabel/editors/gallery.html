<!DOCTYPE html>
<html>

<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <!-- Meta, title, CSS, favicons, etc. -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>视频智能分析软件 | 配置标注</title>
   <!-- Bootstrap -->
   <link href="vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome -->
   <link href="vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
   <!-- Custom styling plus plugins -->
   <link href="css/custom.css" rel="stylesheet">

   <script type="text/javascript">
      var mxBasePath = '../../src';

      var urlParams = (function (url) {
         var result = new Object();
         var params = window.location.search.slice(1).split('&');

         for (var i = 0; i < params.length; i++) {
            idx = params[i].indexOf('=');

            if (idx > 0) {
               result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
            }
         }

         return result;
      })(window.location.href);

      var mxLanguage = urlParams['lang'];
   </script>
   <script type="text/javascript" src="../../src/js/mxClient.js"></script>
   <script type="text/javascript" src="js/app.js"></script>
   <script type="text/javascript">
      let current_video_channel_ = { "deviceid": null, "channelid": null };	// 外部程序需要通过init_preview函数调用初始化本页面的这个结构
      function sleep(ms) {
         return new Promise(resolve => setTimeout(resolve, ms));
      };
      // 本函数实现页面初始化的时候，更新预置点的thumbnail栏。
      function init_preview(devid, channelid, refresh) {
         var onload = function (req) {
            sc = req.getStatus()
            if (sc == 200) {
               var container = document.querySelector("#viewports");
               // var matches = container.querySelectorAll(".preview_img");
               ps = JSON.parse(req.getText());
               var iii;
               for (idx in ps.presets) {
                  url = ps.presets[idx]
                  items = url.split('/')
                  presetid = items[items.length - 1]
                  nd = document.querySelector(`#${presetid}`)
                  if (nd) {
                     req = mxUtils.load(url)
                     base64 = 'data:image/png;base64, ' + req.getText();
                     nd.setAttribute('src', base64)
                  }
               }
            }
         }
         var onerror = function (req) {
            mxUtils.alert('Error');
         }
         url = `/api/v1/v2v/presets/${devid}/${channelid}?refresh=${refresh}`;
         mxUtils.get(url, onload, onerror);
      };
      // Program starts here. The document.onLoad executes the
      // createEditor function with a given configuration.
      // In the config file, the mxEditor.onInit method is
      // overridden to invoke this global function as the
      // last step in the editor constructor.
      function onInit(editor) {
         // Enables rotation handle
         mxVertexHandler.prototype.rotationEnabled = true;

         // Enables guides
         mxGraphHandler.prototype.guidesEnabled = true;

         // Alt disables guides
         mxGuide.prototype.isEnabledForEvent = function (evt) {
            return !mxEvent.isAltDown(evt);
         };

         // Enables snapping waypoints to terminals
         mxEdgeHandler.prototype.snapToTerminals = true;

         // Defines an icon for creating new connections in the connection handler.
         // This will automatically disable the highlighting of the source vertex.
         mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);

         // Enables connections in the graph and disables
         // reset of zoom and translate on root change
         // (ie. switch between XML and graphical mode).
         editor.graph.setConnectable(false);

         // Clones the source if new connection has no target
         editor.graph.connectionHandler.setCreateTarget(true);



         /***** 定义预置点操作 *****/
         var container = document.querySelector("#viewports");
         var matches = container.querySelectorAll(".preview_img");
         var iii;
         for (iii = 0; iii < matches.length; iii++) {
            mxEvent.addListener(matches[iii], 'click', function (evt) {
               nd = evt.currentTarget;
               editor.execute('loadImage', nd);
            });
         }
         // 定义预置点的预览图片被点击的事件处理函数
         var funct = function (editor, nd) {
            var onload = function (req) {
               sc = req.getStatus()
               if (sc == 200) {
                  base64 = 'data:image/png;base64, ' + req.getText();
                  nd.setAttribute('src', base64)		//缩略图
                  sleep(100).then(() => {				//等待渲染获得图片真实大小
                     editor.graph.setBackgroundImage(new mxImage(base64, nd.naturalWidth, nd.naturalHeight));
                     editor.graph.view.validate();	//必须调用以刷新视图背景
                  });
               } else {
                  nd.setAttribute('src', '/viewport/add-viewport.png');
                  editor.graph.setBackgroundImage(new mxImage('/viewport/add-viewport.png', 680, 480));
                  editor.graph.view.validate();	//必须调用以刷新视图背景
               }
            }
            var onerror = function (req) {
               mxUtils.alert('Error');
            }

            url = `/viewport/${current_video_channel_.deviceid}/${nd.id}?refresh=${true}`
            mxUtils.get(url, onload, onerror, true);
         };
         editor.addAction('loadImage', funct);

         // Defines a new action to switch between
         // XML and graphical display
         var textNode = document.getElementById('xml');
         var graphNode = editor.graph.container;
         var sourceInput = document.getElementById('source');
         sourceInput.checked = false;

         var funct = function (editor) {
            if (sourceInput.checked) {
               graphNode.style.display = 'none';
               textNode.style.display = 'inline';

               var enc = new mxCodec();
               var node = enc.encode(editor.graph.getModel());

               textNode.value = mxUtils.getPrettyXml(node);
               textNode.originalValue = textNode.value;
               textNode.focus();
            }
            else {
               graphNode.style.display = '';

               if (textNode.value != textNode.originalValue) {
                  var doc = mxUtils.parseXml(textNode.value);
                  var dec = new mxCodec(doc);
                  dec.decode(doc.documentElement, editor.graph.getModel());
               }

               textNode.originalValue = null;

               // Makes sure nothing is selected in IE
               if (mxClient.IS_IE) {
                  mxUtils.clearSelection();
               }

               textNode.style.display = 'none';

               // Moves the focus back to the graph
               editor.graph.container.focus();
            }
         };

         editor.addAction('switchView', funct);

         // Defines a new action to switch between
         // XML and graphical display
         mxEvent.addListener(sourceInput, 'click', function () {
            editor.execute('switchView');
         });


         $('#group_labels').click(function () {
            editor.execute('group');
         });
         $('#ungroup_labels').click(function () {
            editor.execute('ungroup');
         });
         $('#select_all').click(function () {
            editor.execute('selectAll');
         });
         $('#deselect_all').click(function () {
            editor.execute('selectNone');
         });
         $('#zoom_in').click(function () {
            editor.execute('zoomIn');
         });
         $('#zoom_out').click(function () {
            editor.execute('zoomOut');
         });
         $('#original_size').click(function () {
            editor.execute('actualSize');
         });
         $('#fit_window').click(function () {
            editor.execute('fit');
         });

         viewports = document.getElementById('viewports')
         if (viewports) {
            // viewports.style.cursor = 'wait'
            current_video_channel_.deviceid = viewports.getAttribute('deviceid');
            current_video_channel_.channelid = viewports.getAttribute('channelid');
            init_preview(current_video_channel_.deviceid, current_video_channel_.channelid, true);
            // cur = editor.graph.getCursor()
         }
      }

      window.onbeforeunload = function () { return mxResources.get('changesLost'); };
   </script>

</head>

<body class="nav-md" onload="createEditor('config/diagrameditor.xml');">
   <div class="container">
      <div class="main_container">
         <!-- page content -->
         <div id="page">

            <div class="x_panel " style="width:740px">
               <div class="x_title">
                  <ul class="nav navbar-center panel_toolbox">



                     <li><a id="group_labels"><i class="fa fa-object-group"></i></a></li>
                     <li><a id="ungroup_labels"><i class="fa fa-object-ungroup"></i></a></li>

                     <li><a id="select_all"><i class="fa fa-check-circle"></i></a></li>
                     <li><a id="deselect_all"><i class="fa fa-ban"></i></a></li>
                     <li><a id="zoom_in"><i class="fa fa-search-plus"></i></a></li>
                     <li><a id="zoom_out"><i class="fa fa-search-minus"></i></a></li>
                     <li><a id="original_size"><i class="fa fa-codepen"></i></a></li>
                     <li><a id="fit_window"><i class="fa fa-arrows-alt"></i></a></li>

                     </li>

                  </ul>
                  <div class="clearfix"></div>
               </div>
               <div class="x_content" id="viewports" deviceid='34020000001320000001' , channelid='34020000001310000001'>
                  <div class="row">
                     <table>
                        <tr>
                           <td valign="top"
                              style="border-width:1px;border-style:solid;border-color:rgb(129, 127, 127);">
                              <div id="graph" tabindex="-1"
                                 style="position:relative;height:480px;width:680px;overflow:hidden;cursor:default;">
                                 <!-- Graph Here -->
                                 <center id="splash">
                                    <img src="images/loading.gif">
                                 </center>
                              </div>
                              <textarea id="xml"
                                 style="height:480px;width:680px;display:none;border-style:none;"></textarea>
                           </td>
                           <td id="toolbar" style="width:16px;padding-left:2px;" valign="top">
                              <!-- Toolbar Here -->
                           </td>
                        </tr>
                        <tr>
                           <td>
                              <table class="tb_margin">
                                 <tr>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset1" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset2" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset3" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>

                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset4" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset5" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset6" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>

                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset7" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset8" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                    <td>
                                       <div class="col image view-first">
                                          <img id="preset9" class="preview_img img-thumbnail"
                                             src="/viewport/add-viewport.png" alt="image" />
                                       </div>
                                    </td>
                                 </tr>
                              </table>
                           </td>
                           <td></td>
                        </tr>
                     </table>
                  </div>

                  <div class="row">
                     <div class="col-md-3">
                        <input id="source" style="margin-top: 10px" type="checkbox" /> 源数据
                     </div>
                  </div>
               </div>
            </div>


         </div>
         <!-- /page content -->
      </div>
      <!-- jQuery -->
      <script src="js/jquery.js"></script>
      <!-- Bootstrap -->
      <script src="js/bootstrap.js"></script>
</body>

</html>